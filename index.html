<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartSpend Pro</title>
  
  <!-- Favicon -->
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet" />
  
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <!-- Styles -->
  <link rel="stylesheet" href="css/app.css" />
  <link rel="stylesheet" href="css/themes.css" />
  
  <style>
    /* ===== MOBILE RESPONSIVE FIXES ===== */
    @media (max-width: 768px) {
      /* Show Add Expense button on mobile */
      #quick-expense-form button[type="submit"] {
        display: block !important;
        position: fixed;
        bottom: 80px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        padding: 0;
        z-index: 100;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      }
      
      #quick-expense-form button[type="submit"] i {
        font-size: 20px;
      }
      
      #quick-expense-form button[type="submit"] span {
        display: none;
      }
      
      /* Adjust layout for mobile */
      .app-layout {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border, #e0e0e0);
        position: relative;
      }
      
      .sidebar-content {
        display: block !important;
      }
      
      .main-content {
        padding: 1rem;
      }
      
      /* Make table scrollable on mobile */
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .responsive-table {
        min-width: 600px;
      }
      
      /* Adjust chart size for mobile */
      .chart-container {
        height: 250px !important;
      }
      
      /* Fix header on mobile */
      .header-actions {
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .header-actions .btn {
        padding: 8px 12px;
        font-size: 14px;
      }
      
      /* Show sidebar toggle */
      #sidebar-toggle {
        display: block;
        width: 100%;
        margin-bottom: 15px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        padding: 10px;
        border-radius: 8px;
      }
    }
    
    /* Desktop: Hide sidebar toggle */
    @media (min-width: 769px) {
      #sidebar-toggle {
        display: none;
      }
    }
    
    /* ===== FILTER STYLES ===== */
    .filter-tag.active {
      background: var(--primary, #3B82F6) !important;
      color: white !important;
    }
    
    .filter-group label {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-radius: 8px;
      background: var(--bg-secondary);
      margin-bottom: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .filter-group label:hover {
      background: var(--border);
    }
    
    .filter-group input[type="checkbox"] {
      margin-right: 8px;
    }
    
    /* ===== CHART STYLES ===== */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
      margin: 15px 0;
    }
    
    .chart-placeholder {
      height: 250px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-secondary, #f8f9fa);
      border-radius: 8px;
      color: var(--text-secondary, #6c757d);
      font-style: italic;
      text-align: center;
      padding: 20px;
    }
    
    /* ===== TOAST NOTIFICATIONS ===== */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #10B981;
      color: white;
      padding: 14px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      z-index: 10000;
      animation: slideIn 0.3s ease-out;
      font-weight: 500;
      max-width: 350px;
    }
    
    .toast.error { background: #EF4444; }
    .toast.warning { background: #F59E0B; }
    .toast.info { background: #3B82F6; }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    
    /* ===== BUTTON STYLES ===== */
    .btn-small {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: 500;
    }
    
    .btn-delete {
      background: #EF4444;
      color: white;
    }
    
    .btn-delete:hover {
      background: #DC2626;
    }
    
    /* ===== EMPTY STATE STYLES ===== */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    
    .empty-state i {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.5;
    }
    
    .empty-state h3 {
      margin-bottom: 10px;
      color: var(--text-primary);
    }
    
    /* ===== FIX FOR SIDEBAR ===== */
    .sidebar-content {
      transition: all 0.3s ease;
    }
    
    @media (max-width: 768px) {
      .sidebar.collapsed .sidebar-content {
        display: none !important;
      }
      
      .sidebar:not(.collapsed) .sidebar-content {
        display: block !important;
      }
    }
  </style>
</head>
<body class="theme-light">
  <header class="app-header" role="banner">
    <div class="logo" aria-label="SmartSpend Pro">
      <svg class="logo-icon" viewBox="0 0 32 32" aria-hidden="true">
        <circle cx="16" cy="16" r="15" fill="#3B82F6" opacity="0.1"/>
        <rect x="8" y="12" width="16" height="12" rx="2" fill="#3B82F6"/>
        <circle cx="16" cy="16" r="3" fill="white"/>
        <path d="M10 10h12v2H10z" fill="#3B82F6"/>
      </svg>
      <span class="logo-text">SmartSpend <strong>Pro</strong></span>
    </div>
    <div class="header-actions">
      <button id="theme-toggle" class="btn-icon" aria-label="Toggle dark mode">
        <i class="fas fa-moon" aria-hidden="true"></i>
        <i class="fas fa-sun" aria-hidden="true" style="display: none;"></i>
      </button>
      <button id="export-pdf" class="btn btn-primary" aria-label="Export PDF Report">
        <i class="fas fa-file-pdf"></i> PDF Report
      </button>
      <button id="manage-categories-btn" class="btn btn-secondary" aria-label="Manage Categories">
        <i class="fas fa-tags"></i> Categories
      </button>
    </div>
  </header>
  
  <div class="app-layout">
    <aside class="sidebar" id="sidebar" role="complementary">
      <button id="sidebar-toggle" class="btn-sidebar-toggle" aria-expanded="true">
        <i class="fas fa-bars"></i> Menu
      </button>
      <div class="sidebar-content" id="sidebar-content">
        <section class="sidebar-section">
          <h2 class="sidebar-heading">‚ûï Quick Expense</h2>
          <form id="quick-expense-form" class="quick-form">
            <input type="number" id="quick-amount" step="0.01" min="0.01" placeholder="Amount (e.g., 50.00)" required />
            <input type="text" id="quick-desc" maxlength="50" placeholder="Description (e.g., Coffee)" />
            <select id="quick-category" required style="padding: 0.75rem; border-radius: 8px; border: 1px solid #cbd5e1; width: 100%; margin-bottom: 1rem; background: var(--bg-secondary); color: var(--text-primary);">
              <option value="food">üçï Food</option>
              <option value="travel">‚úàÔ∏è Travel</option>
              <option value="shopping">üõçÔ∏è Shopping</option>
              <option value="bills">üí≥ Bills</option>
              <option value="entertainment">üé¨ Entertainment</option>
              <option value="healthcare">‚öïÔ∏è Healthcare</option>
              <option value="education">üìö Education</option>
              <option value="others">üì¶ Others</option>
            </select>
            <button type="submit" class="btn btn-primary btn-block">
              <i class="fas fa-plus-circle"></i> <span class="btn-text">Add Expense</span>
            </button>
          </form>
        </section>
        
        <section class="sidebar-section">
          <h2 class="sidebar-heading">üìä This Month</h2>
          <div class="summary-card">
            <div class="summary-value" id="total-spent">‚Çπ0.00</div>
            <div class="summary-label">Total Spent</div>
          </div>
          <div class="summary-card">
            <div class="summary-value" id="avg-daily">‚Çπ0.00</div>
            <div class="summary-label">Avg/Day</div>
          </div>
        </section>
        
        <section class="sidebar-section">
          <h2 class="sidebar-heading">üîç Filters</h2>
          <div class="filter-group" id="category-filters">
            <label><input type="checkbox" data-filter="category" value="food"> üçï Food</label>
            <label><input type="checkbox" data-filter="category" value="travel"> ‚úàÔ∏è Travel</label>
            <label><input type="checkbox" data-filter="category" value="shopping"> üõçÔ∏è Shopping</label>
            <label><input type="checkbox" data-filter="category" value="bills"> üí≥ Bills</label>
            <label><input type="checkbox" data-filter="category" value="entertainment"> üé¨ Entertainment</label>
            <label><input type="checkbox" data-filter="category" value="healthcare"> ‚öïÔ∏è Healthcare</label>
            <label><input type="checkbox" data-filter="category" value="education"> üìö Education</label>
            <label><input type="checkbox" data-filter="category" value="others"> üì¶ Others</label>
          </div>
          <div class="filter-group">
            <button id="clear-filters" class="btn-small" style="background: var(--gray-300); color: var(--gray-700); margin-top: 10px;">
              <i class="fas fa-times"></i> Clear Filters
            </button>
          </div>
          <div class="filter-group">
            <label>From: <input type="date" id="date-from" style="margin-left: 5px;"></label>
            <label>To: <input type="date" id="date-to" style="margin-left: 5px;"></label>
          </div>
        </section>
        
        <section class="sidebar-section">
          <h2 class="sidebar-heading">üéØ Budgets</h2>
          <div id="budget-progress-list">
            <div class="empty-state" style="padding: 10px;">
              <small>No budgets set</small>
            </div>
          </div>
        </section>
      </div>
    </aside>
    
    <main id="main-content" class="main-content">
      <div class="page-header">
        <h1>Expenses</h1>
        <div class="controls">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="search-input" placeholder="Search expenses‚Ä¶" />
          </div>
          <div class="sort-controls">
            <label>
              Sort by:
              <select id="sort-by">
                <option value="date-desc">Date (Newest)</option>
                <option value="amount-desc">Amount (High‚ÜíLow)</option>
                <option value="category">Category</option>
              </select>
            </label>
          </div>
        </div>
      </div>
      
      <section class="expenses-section">
        <div class="table-container">
          <table id="expenses-table" class="responsive-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Category</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="expenses-table-body">
              <tr class="no-data"><td colspan="5">No expenses yet. Add one!</td></tr>
            </tbody>
          </table>
        </div>
      </section>
      
      <section class="charts-section">
        <h2>üìà Monthly Insights</h2>
        <div class="chart-grid">
          <div class="chart-card">
            <h3>Spending by Category</h3>
            <div class="chart-container">
              <canvas id="category-chart"></canvas>
              <div id="category-chart-placeholder" class="chart-placeholder">
                <div style="text-align: center; padding: 20px;">
                  <i class="fas fa-pie-chart" style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;"></i>
                  <p>Add expenses to see category breakdown</p>
                </div>
              </div>
            </div>
          </div>
          <div class="chart-card">
            <h3>30-Day Trend</h3>
            <div class="chart-container">
              <canvas id="trend-chart"></canvas>
              <div id="trend-chart-placeholder" class="chart-placeholder">
                <div style="text-align: center; padding: 20px;">
                  <i class="fas fa-chart-line" style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;"></i>
                  <p>Add expenses to see spending trends</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      
      <section class="stats-section">
        <h2>‚ú® Quick Stats</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="stat-total">‚Çπ0.00</div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-count">0</div>
            <div class="stat-label">Expenses</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-top">‚Äî</div>
            <div class="stat-label">Top</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-avg">‚Çπ0.00</div>
            <div class="stat-label">Avg</div>
          </div>
        </div>
      </section>
    </main>
    
    <!-- Mobile Add Expense Button (shown only on mobile) -->
    <button id="mobile-add-btn" class="fab" aria-label="Add expense" style="display: none;">
      <i class="fas fa-plus"></i>
    </button>
    
    <!-- Floating Action Button for Desktop -->
    <button id="fab" class="fab" aria-label="Add expense">
      <i class="fas fa-plus"></i>
    </button>
    
    <div id="category-modal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <div class="modal-header">
          <h2>‚ûï Manage Categories</h2>
          <button id="close-category-modal" class="btn-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
          <div id="categories-list"></div>
          <button id="add-custom-category-btn" class="btn btn-secondary btn-block mt-2">
            <i class="fas fa-plus-circle"></i> Add New Category
          </button>
        </div>
      </div>
    </div>
    
    <div id="toast-container" aria-live="polite"></div>
  </div>

  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>

  <!-- Main Application Script -->
  <script>
    // SmartSpend Pro - Complete Working Application
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ SmartSpend Pro loaded');
      
      // ===== INITIALIZATION =====
      // Theme
      const savedTheme = localStorage.getItem('smartSpendTheme') || 'light';
      document.body.className = 'theme-' + savedTheme;
      
      // Data
      let expenses = JSON.parse(localStorage.getItem('smartSpendExpenses')) || [];
      
      // Charts
      let categoryChart = null;
      let trendChart = null;
      
      // Filters state
      let activeFilters = {
        categories: [],
        dateFrom: null,
        dateTo: null
      };
      
      // Categories
      const categories = {
        'food': { name: 'Food', icon: 'üçï', color: '#4CAF50' },
        'travel': { name: 'Travel', icon: '‚úàÔ∏è', color: '#2196F3' },
        'shopping': { name: 'Shopping', icon: 'üõçÔ∏è', color: '#FF9800' },
        'bills': { name: 'Bills', icon: 'üí≥', color: '#9C27B0' },
        'entertainment': { name: 'Entertainment', icon: 'üé¨', color: '#E91E63' },
        'healthcare': { name: 'Healthcare', icon: '‚öïÔ∏è', color: '#00BCD4' },
        'education': { name: 'Education', icon: 'üìö', color: '#3F51B5' },
        'others': { name: 'Others', icon: 'üì¶', color: '#607D8B' }
      };
      
      // ===== DOM ELEMENTS =====
      const expenseForm = document.getElementById('quick-expense-form');
      const amountInput = document.getElementById('quick-amount');
      const descInput = document.getElementById('quick-desc');
      const categorySelect = document.getElementById('quick-category');
      const expensesBody = document.getElementById('expenses-table-body');
      const searchInput = document.getElementById('search-input');
      const sortSelect = document.getElementById('sort-by');
      const totalSpentElement = document.getElementById('total-spent');
      const avgDailyElement = document.getElementById('avg-daily');
      const statTotalElement = document.getElementById('stat-total');
      const statCountElement = document.getElementById('stat-count');
      const statTopElement = document.getElementById('stat-top');
      const statAvgElement = document.getElementById('stat-avg');
      const themeToggle = document.getElementById('theme-toggle');
      const exportPdfBtn = document.getElementById('export-pdf');
      const fabBtn = document.getElementById('fab');
      const mobileAddBtn = document.getElementById('mobile-add-btn');
      const sidebarToggle = document.getElementById('sidebar-toggle');
      const clearFiltersBtn = document.getElementById('clear-filters');
      const dateFromInput = document.getElementById('date-from');
      const dateToInput = document.getElementById('date-to');
      const categoryFilters = document.querySelectorAll('#category-filters input[type="checkbox"]');
      const categoryChartCanvas = document.getElementById('category-chart');
      const trendChartCanvas = document.getElementById('trend-chart');
      const categoryPlaceholder = document.getElementById('category-chart-placeholder');
      const trendPlaceholder = document.getElementById('trend-chart-placeholder');
      
      // ===== HELPER FUNCTIONS =====
      // Show Toast
      function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: ${type === 'error' ? '#EF4444' : type === 'warning' ? '#F59E0B' : type === 'info' ? '#3B82F6' : '#10B981'};
          color: white;
          padding: 14px 24px;
          border-radius: 8px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
          z-index: 10000;
          animation: slideIn 0.3s ease-out;
          font-weight: 500;
          max-width: 350px;
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.animation = 'slideOut 0.3s ease-out';
          setTimeout(() => {
            if (toast.parentNode) {
              document.body.removeChild(toast);
            }
          }, 300);
        }, 3000);
      }
      
      // Get filtered expenses
      function getFilteredExpenses() {
        let filtered = [...expenses];
        
        // Filter by category
        if (activeFilters.categories.length > 0) {
          filtered = filtered.filter(exp => activeFilters.categories.includes(exp.category));
        }
        
        // Filter by date range
        if (activeFilters.dateFrom) {
          filtered = filtered.filter(exp => new Date(exp.date) >= new Date(activeFilters.dateFrom));
        }
        
        if (activeFilters.dateTo) {
          const toDate = new Date(activeFilters.dateTo);
          toDate.setHours(23, 59, 59, 999); // End of day
          filtered = filtered.filter(exp => new Date(exp.date) <= toDate);
        }
        
        return filtered;
      }
      
      // Update filter UI
      function updateFilterUI() {
        // Update checkbox states
        categoryFilters.forEach(checkbox => {
          checkbox.checked = activeFilters.categories.includes(checkbox.value);
        });
        
        // Update date inputs
        dateFromInput.value = activeFilters.dateFrom || '';
        dateToInput.value = activeFilters.dateTo || '';
        
        // Show filter status
        const filterCount = activeFilters.categories.length + 
                          (activeFilters.dateFrom ? 1 : 0) + 
                          (activeFilters.dateTo ? 1 : 0);
        
        if (filterCount > 0) {
          clearFiltersBtn.innerHTML = `<i class="fas fa-times"></i> Clear Filters (${filterCount})`;
        } else {
          clearFiltersBtn.innerHTML = `<i class="fas fa-times"></i> Clear Filters`;
        }
      }
      
      // ===== CORE FUNCTIONS =====
      // Add Expense
      function addExpense(amount, category, description) {
        const newExpense = {
          id: Date.now(),
          amount: parseFloat(amount),
          category: category,
          description: description || 'Expense',
          date: new Date().toISOString().split('T')[0],
          time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
          timestamp: Date.now()
        };
        
        expenses.push(newExpense);
        saveData();
        updateUI();
        showToast(`‚úÖ Added ‚Çπ${amount} for ${description || 'expense'}`, 'success');
        
        return newExpense;
      }
      
      // Delete Expense
      function deleteExpense(id) {
        if (confirm('Delete this expense?')) {
          expenses = expenses.filter(exp => exp.id !== id);
          saveData();
          updateUI();
          showToast('üóëÔ∏è Expense deleted', 'info');
        }
      }
      
      // Save Data
      function saveData() {
        localStorage.setItem('smartSpendExpenses', JSON.stringify(expenses));
      }
      
      // Calculate Statistics
      function calculateStats(filteredExpenses) {
        if (filteredExpenses.length === 0) {
          return {
            total: 0,
            count: 0,
            average: 0,
            topCategory: '‚Äî',
            today: 0,
            week: 0,
            avgDaily: 0
          };
        }
        
        const total = filteredExpenses.reduce((sum, exp) => sum + exp.amount, 0);
        const average = total / filteredExpenses.length;
        
        // Top category by amount
        const categoryTotals = {};
        filteredExpenses.forEach(exp => {
          categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + exp.amount;
        });
        
        let topCategory = '‚Äî';
        let maxAmount = 0;
        for (const [cat, amount] of Object.entries(categoryTotals)) {
          if (amount > maxAmount) {
            maxAmount = amount;
            topCategory = categories[cat]?.name || cat;
          }
        }
        
        // Today's expenses
        const today = new Date().toISOString().split('T')[0];
        const todayExpenses = filteredExpenses.filter(exp => exp.date === today);
        const todayTotal = todayExpenses.reduce((sum, exp) => sum + exp.amount, 0);
        
        // Average daily (last 30 days)
        const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
        const last30DaysExpenses = filteredExpenses.filter(exp => {
          const expDate = new Date(exp.date);
          return expDate >= thirtyDaysAgo;
        });
        const thirtyDayTotal = last30DaysExpenses.reduce((sum, exp) => sum + exp.amount, 0);
        const avgDaily = thirtyDayTotal / 30;
        
        return {
          total: total.toFixed(2),
          count: filteredExpenses.length,
          average: average.toFixed(2),
          topCategory: topCategory,
          today: todayTotal.toFixed(2),
          week: todayTotal.toFixed(2), // Simplified for now
          avgDaily: avgDaily.toFixed(2)
        };
      }
      
      // Update Charts
      function updateCharts(filteredExpenses) {
        // Category Chart
        if (filteredExpenses.length > 0) {
          categoryPlaceholder.style.display = 'none';
          categoryChartCanvas.style.display = 'block';
          
          const categoryData = {};
          filteredExpenses.forEach(exp => {
            const cat = categories[exp.category]?.name || exp.category;
            categoryData[cat] = (categoryData[cat] || 0) + exp.amount;
          });
          
          const chartLabels = Object.keys(categoryData);
          const chartData = Object.values(categoryData);
          const chartColors = chartLabels.map(label => {
            const cat = Object.values(categories).find(c => c.name === label);
            return cat ? cat.color : '#607D8B';
          });
          
          if (categoryChart) {
            categoryChart.destroy();
          }
          
          const ctx1 = categoryChartCanvas.getContext('2d');
          categoryChart = new Chart(ctx1, {
            type: 'doughnut',
            data: {
              labels: chartLabels,
              datasets: [{
                data: chartData,
                backgroundColor: chartColors,
                borderWidth: 2,
                borderColor: '#fff',
                hoverOffset: 15
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    padding: 20,
                    font: {
                      size: 11
                    },
                    boxWidth: 12
                  }
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      let label = context.label || '';
                      if (label) {
                        label += ': ';
                      }
                      label += '‚Çπ' + context.raw.toFixed(2);
                      return label;
                    }
                  }
                }
              },
              cutout: '65%'
            }
          });
        } else {
          categoryPlaceholder.style.display = 'flex';
          categoryChartCanvas.style.display = 'none';
        }
        
        // Trend Chart (Last 7 days)
        if (filteredExpenses.length >= 2) {
          trendPlaceholder.style.display = 'none';
          trendChartCanvas.style.display = 'block';
          
          // Get last 7 days
          const days = [];
          const dailyTotals = {};
          const today = new Date();
          
          for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
            dailyTotals[dateStr] = 0;
          }
          
          // Calculate daily totals
          filteredExpenses.forEach(exp => {
            if (dailyTotals[exp.date] !== undefined) {
              dailyTotals[exp.date] += exp.amount;
            }
          });
          
          const trendData = Object.values(dailyTotals);
          
          if (trendChart) {
            trendChart.destroy();
          }
          
          const ctx2 = trendChartCanvas.getContext('2d');
          trendChart = new Chart(ctx2, {
            type: 'line',
            data: {
              labels: days,
              datasets: [{
                label: 'Daily Spending',
                data: trendData,
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#3B82F6',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  mode: 'index',
                  intersect: false,
                  callbacks: {
                    label: function(context) {
                      return '‚Çπ' + context.raw.toFixed(2);
                    }
                  }
                }
              },
              scales: {
                x: {
                  grid: {
                    display: false
                  },
                  ticks: {
                    font: {
                      size: 11
                    }
                  }
                },
                y: {
                  beginAtZero: true,
                  grid: {
                    color: 'rgba(0,0,0,0.05)'
                  },
                  ticks: {
                    callback: function(value) {
                      return '‚Çπ' + value;
                    },
                    font: {
                      size: 11
                    },
                    maxTicksLimit: 6
                  }
                }
              },
              interaction: {
                intersect: false,
                mode: 'nearest'
              }
            }
          });
        } else {
          trendPlaceholder.style.display = 'flex';
          trendChartCanvas.style.display = 'none';
        }
      }
      
      // Update UI
      function updateUI() {
        const filteredExpenses = getFilteredExpenses();
        const stats = calculateStats(filteredExpenses);
        
        // Update stats
        totalSpentElement.textContent = `‚Çπ${stats.total}`;
        avgDailyElement.textContent = `‚Çπ${stats.avgDaily}`;
        statTotalElement.textContent = `‚Çπ${stats.total}`;
        statCountElement.textContent = stats.count;
        statTopElement.textContent = stats.topCategory;
        statAvgElement.textContent = `‚Çπ${stats.average}`;
        
        // Update expenses table
        if (filteredExpenses.length === 0) {
          let message = 'No expenses yet. Add one!';
          
          if (expenses.length > 0) {
            if (activeFilters.categories.length > 0) {
              const selectedCategories = activeFilters.categories.map(cat => categories[cat]?.name || cat).join(', ');
              message = `No expenses found for selected categories: ${selectedCategories}`;
            } else if (activeFilters.dateFrom || activeFilters.dateTo) {
              message = 'No expenses found for selected date range';
            } else {
              message = 'No expenses match your search';
            }
          }
          
          expensesBody.innerHTML = `
            <tr class="no-data">
              <td colspan="5" style="text-align: center; padding: 40px;">
                <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5; display: block;"></i>
                <h3 style="margin-bottom: 10px; color: var(--text-primary);">${message}</h3>
                ${expenses.length > 0 ? '<p style="color: var(--text-secondary);">Try changing your filters or search term</p>' : ''}
              </td>
            </tr>
          `;
        } else {
          // Sort expenses
          let sortedExpenses = [...filteredExpenses];
          const sortBy = sortSelect.value;
          
          if (sortBy === 'date-desc') {
            sortedExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
          } else if (sortBy === 'amount-desc') {
            sortedExpenses.sort((a, b) => b.amount - a.amount);
          } else if (sortBy === 'category') {
            sortedExpenses.sort((a, b) => (categories[a.category]?.name || a.category).localeCompare(categories[b.category]?.name || b.category));
          }
          
          // Search filter
          const searchTerm = searchInput.value.toLowerCase();
          if (searchTerm) {
            sortedExpenses = sortedExpenses.filter(exp => 
              exp.description.toLowerCase().includes(searchTerm) ||
              (categories[exp.category]?.name || exp.category).toLowerCase().includes(searchTerm)
            );
          }
          
          // Build table
          let html = '';
          sortedExpenses.forEach(exp => {
            const category = categories[exp.category] || { name: exp.category, icon: 'üìù', color: '#666' };
            html += `
              <tr>
                <td><strong>${exp.date}</strong><br><small>${exp.time}</small></td>
                <td><span style="color:${category.color}">${category.icon} ${category.name}</span></td>
                <td>${exp.description}</td>
                <td><strong style="color:#E91E63">‚Çπ${exp.amount.toFixed(2)}</strong></td>
                <td><button onclick="deleteExpense(${exp.id})" class="btn-small btn-delete"><i class="fas fa-trash"></i> Delete</button></td>
              </tr>
            `;
          });
          
          if (sortedExpenses.length === 0) {
            html = `
              <tr class="no-data">
                <td colspan="5" style="text-align: center; padding: 40px;">
                  <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5; display: block;"></i>
                  <h3 style="margin-bottom: 10px;">No expenses match your search</h3>
                  <p style="color: var(--text-secondary);">Try a different search term</p>
                </td>
              </tr>
            `;
          }
          
          expensesBody.innerHTML = html;
        }
        
        // Update charts
        updateCharts(filteredExpenses);
        
        // Update filter UI
        updateFilterUI();
      }
      
      // Export PDF
      function exportPDF() {
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          const filteredExpenses = getFilteredExpenses();
          const stats = calculateStats(filteredExpenses);
          
          // Title
          doc.setFontSize(20);
          doc.setTextColor(59, 130, 246);
          doc.text('SmartSpend Pro Report', 105, 20, { align: 'center' });
          
          doc.setFontSize(11);
          doc.setTextColor(100, 100, 100);
          doc.text(`Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 105, 28, { align: 'center' });
          
          // Summary
          doc.setFontSize(14);
          doc.setTextColor(0, 0, 0);
          doc.text('Summary Statistics', 20, 45);
          
          doc.setFontSize(11);
          doc.text(`Total Expenses: ${stats.count}`, 20, 55);
          doc.text(`Total Amount: ‚Çπ${stats.total}`, 20, 62);
          doc.text(`Average per Expense: ‚Çπ${stats.average}`, 20, 69);
          doc.text(`Top Category: ${stats.topCategory}`, 20, 76);
          
          // Filter info
          if (activeFilters.categories.length > 0 || activeFilters.dateFrom || activeFilters.dateTo) {
            doc.text('Filters Applied:', 20, 86);
            let filterText = '';
            if (activeFilters.categories.length > 0) {
              filterText += 'Categories: ' + activeFilters.categories.map(cat => categories[cat]?.name || cat).join(', ');
            }
            if (activeFilters.dateFrom || activeFilters.dateTo) {
              if (filterText) filterText += ', ';
              filterText += 'Date Range: ' + (activeFilters.dateFrom || 'Start') + ' to ' + (activeFilters.dateTo || 'End');
            }
            doc.text(filterText, 20, 93, { maxWidth: 170 });
          }
          
          // Recent Expenses Table
          const tableData = filteredExpenses.slice(-15).map(exp => [
            exp.date,
            categories[exp.category]?.name || exp.category,
            exp.description,
            `‚Çπ${exp.amount.toFixed(2)}`
          ]);
          
          if (tableData.length > 0) {
            doc.autoTable({
              startY: 105,
              head: [['Date', 'Category', 'Description', 'Amount']],
              body: tableData,
              theme: 'grid',
              headStyles: { fillColor: [59, 130, 246] }
            });
          }
          
          // Footer
          const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : 120;
          doc.setFontSize(10);
          doc.setTextColor(150, 150, 150);
          doc.text('SmartSpend Pro - Your Personal Expense Tracker', 105, finalY, { align: 'center' });
          
          // Save PDF
          doc.save(`SmartSpend-Report-${new Date().toISOString().split('T')[0]}.pdf`);
          
          showToast('üìÑ PDF report generated successfully!', 'success');
        } catch (error) {
          console.error('PDF export error:', error);
          showToast('‚ùå Failed to generate PDF. Please try again.', 'error');
        }
      }
      
      // ===== EVENT LISTENERS =====
      // Form submission
      expenseForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const amount = amountInput.value;
        const description = descInput.value || 'Expense';
        const category = categorySelect.value;
        
        if (!amount || amount <= 0) {
          showToast('‚ùå Please enter a valid amount', 'error');
          amountInput.focus();
          return;
        }
        
        addExpense(amount, category, description);
        
        // Reset form
        amountInput.value = '';
        descInput.value = '';
        amountInput.focus();
      });
      
      // Theme toggle
      themeToggle.addEventListener('click', function() {
        const isDark = document.body.classList.contains('theme-dark');
        const newTheme = isDark ? 'light' : 'dark';
        document.body.className = 'theme-' + newTheme;
        localStorage.setItem('smartSpendTheme', newTheme);
        
        const moonIcon = this.querySelector('.fa-moon');
        const sunIcon = this.querySelector('.fa-sun');
        moonIcon.style.display = isDark ? 'inline' : 'none';
        sunIcon.style.display = isDark ? 'none' : 'inline';
        this.setAttribute('aria-label', isDark ? 'Switch to light mode' : 'Switch to dark mode');
        
        showToast(isDark ? 'üåû Switched to light mode' : 'üåô Switched to dark mode', 'info');
      });
      
      // PDF Export
      exportPdfBtn.addEventListener('click', exportPDF);
      
      // FAB button (Desktop)
      fabBtn.addEventListener('click', function() {
        amountInput.focus();
        document.querySelector('.sidebar').scrollIntoView({ behavior: 'smooth' });
        showToast('‚úèÔ∏è Ready to add new expense!', 'info');
      });
      
      // Mobile Add button
      mobileAddBtn.addEventListener('click', function() {
        amountInput.focus();
        document.querySelector('.sidebar').scrollIntoView({ behavior: 'smooth' });
        showToast('‚úèÔ∏è Ready to add new expense!', 'info');
      });
      
      // Search
      searchInput.addEventListener('input', updateUI);
      
      // Sort
      sortSelect.addEventListener('change', updateUI);
      
      // Sidebar toggle (mobile)
      sidebarToggle.addEventListener('click', function() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('collapsed');
        const isExpanded = !sidebar.classList.contains('collapsed');
        this.setAttribute('aria-expanded', isExpanded);
        this.innerHTML = isExpanded ? '<i class="fas fa-bars"></i> Menu' : '<i class="fas fa-bars"></i> Show Menu';
      });
      
      // Category filters
      categoryFilters.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          if (this.checked) {
            if (!activeFilters.categories.includes(this.value)) {
              activeFilters.categories.push(this.value);
            }
          } else {
            activeFilters.categories = activeFilters.categories.filter(cat => cat !== this.value);
          }
          updateUI();
        });
      });
      
      // Date filters
      dateFromInput.addEventListener('change', function() {
        activeFilters.dateFrom = this.value;
        updateUI();
      });
      
      dateToInput.addEventListener('change', function() {
        activeFilters.dateTo = this.value;
        updateUI();
      });
      
      // Clear filters
      clearFiltersBtn.addEventListener('click', function() {
        activeFilters.categories = [];
        activeFilters.dateFrom = null;
        activeFilters.dateTo = null;
        updateUI();
        showToast('üßπ Filters cleared', 'info');
      });
      
      // ===== MOBILE DETECTION =====
      function checkMobile() {
        const isMobile = window.innerWidth <= 768;
        
        if (isMobile) {
          mobileAddBtn.style.display = 'block';
          fabBtn.style.display = 'none';
          // Ensure sidebar is collapsed by default on mobile
          document.getElementById('sidebar').classList.add('collapsed');
          sidebarToggle.setAttribute('aria-expanded', 'false');
          sidebarToggle.innerHTML = '<i class="fas fa-bars"></i> Show Menu';
        } else {
          mobileAddBtn.style.display = 'none';
          fabBtn.style.display = 'block';
          document.getElementById('sidebar').classList.remove('collapsed');
          sidebarToggle.setAttribute('aria-expanded', 'true');
          sidebarToggle.innerHTML = '<i class="fas fa-bars"></i> Menu';
        }
      }
      
      // ===== INITIALIZE =====
      // Make functions globally available
      window.deleteExpense = deleteExpense;
      
      // Debug tools
      window.smartSpendDebug = {
        addTestExpense: function(amount = 100, category = 'food', description = 'Test Item') {
          return addExpense(amount, category, description);
        },
        clearData: function() {
          if (confirm('Clear ALL expenses? This cannot be undone.')) {
            expenses = [];
            saveData();
            updateUI();
            showToast('üóëÔ∏è All data cleared', 'warning');
          }
        },
        showData: function() {
          console.log('üìä Current expenses:', expenses);
          console.log('üìà Statistics:', calculateStats(expenses));
          showToast('üìä Data logged to console', 'info');
          return {
            expenses: expenses,
            stats: calculateStats(expenses)
          };
        },
        addSampleData: function() {
          const samples = [
            [56, 'food', 'Lunch'],
            [150, 'travel', 'Train ticket'],
            [299, 'shopping', 'New shoes'],
            [45, 'food', 'Coffee'],
            [120, 'entertainment', 'Movie tickets'],
            [89, 'bills', 'Electricity bill'],
            [65, 'healthcare', 'Medicine'],
            [199, 'shopping', 'Groceries'],
            [30000, 'others', 'Big purchase']
          ];
          
          samples.forEach(([amount, category, desc], i) => {
            setTimeout(() => {
              addExpense(amount, category, desc);
            }, i * 200);
          });
          
          showToast('üìä Added sample data', 'success');
        }
      };
      
      console.log('‚úÖ SmartSpend Pro initialized');
      console.log('üëâ Type "smartSpendDebug" in console for debug tools');
      
      // Initial UI update
      updateUI();
      checkMobile();
      
      // Update theme button state
      const isDark = savedTheme === 'dark';
      const moonIcon = themeToggle.querySelector('.fa-moon');
      const sunIcon = themeToggle.querySelector('.fa-sun');
      moonIcon.style.display = isDark ? 'none' : 'inline';
      sunIcon.style.display = isDark ? 'inline' : 'none';
      themeToggle.setAttribute('aria-label', isDark ? 'Switch to light mode' : 'Switch to dark mode');
      
      // Listen for window resize
      window.addEventListener('resize', checkMobile);
    });
  </script>
</body>
</html>
